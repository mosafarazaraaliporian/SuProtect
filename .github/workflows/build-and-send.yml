name: Build and Send to Telegram

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Build APK
      run: flutter build apk --release
      
    - name: Get APK info
      id: apk_info
      run: |
        APK_PATH=$(find build/app/outputs/flutter-apk -name "*.apk" | head -n 1)
        APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
        APK_NAME=$(basename "$APK_PATH")
        echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
        echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
        echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
        echo "APK Path: $APK_PATH"
        echo "APK Name: $APK_NAME"
        echo "APK Size: $APK_SIZE"
        
    - name: Send APK to Telegram
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        document: ${{ steps.apk_info.outputs.apk_path }}
        caption: |
          ğŸš€ *SuProtect Build Successful*
          
          ğŸ“¦ *File:* ${{ steps.apk_info.outputs.apk_name }}
          ğŸ“Š *Size:* ${{ steps.apk_info.outputs.apk_size }}
          ğŸ”– *Branch:* ${{ github.ref_name }}
          ğŸ“ *Commit:* ${{ github.sha }}
          ğŸ‘¤ *Author:* ${{ github.actor }}
          ğŸ“… *Date:* ${{ github.event.head_commit.timestamp }}
          
          âœ… Build completed successfully!
        parse_mode: markdown

